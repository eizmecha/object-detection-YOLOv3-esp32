<?xml version="1.0"?>
<!--
Super Stingray QuadPlane VTOL — FULL PROFESSIONAL MODEL (Parts 1–4 merged)
Target stack:
- Ubuntu 24.04.x
- Gazebo Harmonic (gz sim)
- ArduPilot SITL: ArduPlane QuadPlane (--model JSON)
- QGroundControl for missions

Design goals for capstone:
1) Stable VTOL hover (no rapid forward flip).
2) Valid transition and fixed-wing cruise (S5020-based aero, 70–90 km/h target band).
3) Sensor set compatible with ArduPilot: IMU, GPS, MAG, airspeed.
4) Clean architecture for digital twin (telemetry mirroring) without corrupting SITL physics.

Key stability decisions:
- NO LiftDrag used for propeller/rotor thrust (LiftDrag is for wings/foils in airflow).
- Rotor links are kept with near-zero inertia to avoid gyroscopic flip.
- Thrust/torque are produced by MulticopterMotorModel systems using joint angular velocity.
- Elevon offsets are set to 0 (no hidden trim torque on boot).

Notes:
- Keep your CG origin at (0,0,0) in CAD as you did.
- Your axis convention in the model: X forward, Y left, Z up.
- ArduPilot expects FRD/NED internally; transforms are handled in the ArduPilotPlugin.
-->

<sdf version="1.9">
  <model name="super_hybrid_vtol">
    <static>false</static>
    <self_collide>false</self_collide>
    <pose>0 0 0.30 0 0 0</pose>

    <!-- ===================== -->
    <!-- BASE LINK (AIRFRAME)  -->
    <!-- ===================== -->
    <link name="base_link">
      <pose>0 0 0 0 0 0</pose>

      <inertial>
        <pose>0 0 0 0 0 0</pose>
        <!-- Base mass: adjust if you later distribute mass across links.
             Target AUW around 2.8 kg total with all components. -->
        <mass>2.45</mass>
        <inertia>
          <ixx>0.20</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>0.15</iyy>
          <iyz>0</iyz>
          <izz>0.25</izz>
        </inertia>
      </inertial>

      <collision name="base_link_collision">
        <pose>0 0 -0.05 0 0 0</pose>
        <geometry>
          <box>
            <size>0.70 1.13 0.108</size>
          </box>
        </geometry>
        <surface>
          <friction>
            <ode>
              <mu>1.0</mu>
              <mu2>1.0</mu2>
            </ode>
          </friction>
          <contact>
            <ode>
              <kp>500000</kp>
              <kd>50</kd>
              <min_depth>0.001</min_depth>
            </ode>
          </contact>
        </surface>
      </collision>

      <visual name="base_link_visual">
        <pose>0 0 -0.38621 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/super_fus.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material>
          <ambient>0.60 0.60 0.60 1</ambient>
          <diffuse>0.60 0.60 0.60 1</diffuse>
        </material>
      </visual>

      <!-- GPS sensor: in Gazebo Harmonic this is a world sensor. -->
      <sensor name="gps_sensor" type="gps">
        <always_on>true</always_on>
        <update_rate>10</update_rate>
      </sensor>
    </link>

    <!-- ============================ -->
    <!-- VTOL ROTORS (VISUAL + JOINT) -->
    <!-- ============================ -->
    <!-- Rotors are modeled as nearly massless spinning links.
         Thrust/torque are generated by MulticopterMotorModel plugins (below). -->

    <!-- rotor_0: front-right (CCW) -->
    <link name="rotor_0">
      <pose relative_to="base_link">0.19257 -0.21068 -0.0045 0 0 0</pose>
      <inertial>
        <mass>0.001</mass>
        <inertia>
          <ixx>1e-7</ixx><iyy>1e-7</iyy><izz>1e-7</izz>
        </inertia>
      </inertial>
      <visual name="rotor_0_visual">
        <pose>-0.0070034310 -0.0647861960 -0.0065644327 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/vtol_prop_ccw.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material><ambient>0 0 0 1</ambient><diffuse>0 0 0 1</diffuse></material>
      </visual>
    </link>

    <joint name="rotor_0_joint" type="revolute">
      <parent>base_link</parent>
      <child>rotor_0</child>
      <axis>
        <xyz>0 0 1</xyz>
        <limit><lower>-1e16</lower><upper>1e16</upper></limit>
        <dynamics><damping>0.001</damping></dynamics>
      </axis>
    </joint>

    <!-- rotor_1: rear-left (CCW) -->
    <link name="rotor_1">
      <pose relative_to="base_link">-0.33549 0.21128 -0.0045 0 0 0</pose>
      <inertial>
        <mass>0.001</mass>
        <inertia>
          <ixx>1e-7</ixx><iyy>1e-7</iyy><izz>1e-7</izz>
        </inertia>
      </inertial>
      <visual name="rotor_1_visual">
        <pose>-0.0070034310 -0.0647861960 -0.0065644327 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/vtol_prop_ccw.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material><ambient>0 0 0 1</ambient><diffuse>0 0 0 1</diffuse></material>
      </visual>
    </link>

    <joint name="rotor_1_joint" type="revolute">
      <parent>base_link</parent>
      <child>rotor_1</child>
      <axis>
        <xyz>0 0 1</xyz>
        <limit><lower>-1e16</lower><upper>1e16</upper></limit>
        <dynamics><damping>0.001</damping></dynamics>
      </axis>
    </joint>

    <!-- rotor_2: front-left (CW) -->
    <link name="rotor_2">
      <pose relative_to="base_link">0.19571 0.21128 -0.0045 0 0 0</pose>
      <inertial>
        <mass>0.001</mass>
        <inertia>
          <ixx>1e-7</ixx><iyy>1e-7</iyy><izz>1e-7</izz>
        </inertia>
      </inertial>
      <visual name="rotor_2_visual">
        <pose>-0.0070594754 -0.0647858828 -0.0066520433 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/vtol_prop_cw.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material><ambient>0 0 0 1</ambient><diffuse>0 0 0 1</diffuse></material>
      </visual>
    </link>

    <joint name="rotor_2_joint" type="revolute">
      <parent>base_link</parent>
      <child>rotor_2</child>
      <axis>
        <xyz>0 0 1</xyz>
        <limit><lower>-1e16</lower><upper>1e16</upper></limit>
        <dynamics><damping>0.001</damping></dynamics>
      </axis>
    </joint>

    <!-- rotor_3: rear-right (CW) -->
    <link name="rotor_3">
      <pose relative_to="base_link">-0.33863 -0.21068 -0.0045 0 0 0</pose>
      <inertial>
        <mass>0.001</mass>
        <inertia>
          <ixx>1e-7</ixx><iyy>1e-7</iyy><izz>1e-7</izz>
        </inertia>
      </inertial>
      <visual name="rotor_3_visual">
        <pose>-0.0070594754 -0.0647858828 -0.0066520433 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/vtol_prop_cw.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material><ambient>0 0 0 1</ambient><diffuse>0 0 0 1</diffuse></material>
      </visual>
    </link>

    <joint name="rotor_3_joint" type="revolute">
      <parent>base_link</parent>
      <child>rotor_3</child>
      <axis>
        <xyz>0 0 1</xyz>
        <limit><lower>-1e16</lower><upper>1e16</upper></limit>
        <dynamics><damping>0.001</damping></dynamics>
      </axis>
    </joint>

    <!-- Pusher rotor (spins about X axis) -->
    <link name="rotor_pusher">
      <pose relative_to="base_link">-0.2953 0 -0.0065 0 0 0</pose>
      <inertial>
        <mass>0.002</mass>
        <inertia>
          <ixx>2e-7</ixx><iyy>2e-7</iyy><izz>2e-7</izz>
        </inertia>
      </inertial>
      <visual name="rotor_pusher_visual">
        <pose>-0.0075749999 -0.0125011178 -0.1267471462 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/super_pusher_prop.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material><ambient>0 0 0 1</ambient><diffuse>0 0 0 1</diffuse></material>
      </visual>
    </link>

    <joint name="rotor_pusher_joint" type="revolute">
      <parent>base_link</parent>
      <child>rotor_pusher</child>
      <axis>
        <xyz>1 0 0</xyz>
        <limit><lower>-1e16</lower><upper>1e16</upper></limit>
        <dynamics><damping>0.001</damping></dynamics>
      </axis>
    </joint>

    <!-- ============================================= -->
    <!-- MOTOR THRUST MODEL (REAL THRUST, NO LiftDrag) -->
    <!-- ============================================= -->
    <!-- Start-point sizing from your thrust statement:
         ~1.4 kg at 80% => ~17.2 N max thrust per lift motor (approx).
         If max omega ~2200 rad/s: motor_constant ~ 3.6e-6.
         Tune later using bench curves if available. -->

    <plugin filename="gz-sim-multicopter-motor-model-system"
            name="gz::sim::systems::MulticopterMotorModel">
      <joint_name>rotor_0_joint</joint_name>
      <link_name>base_link</link_name>
      <turning_direction>ccw</turning_direction>
      <motor_constant>3.6e-6</motor_constant>
      <moment_constant>1.0e-7</moment_constant>
      <max_rot_velocity>2200</max_rot_velocity>
      <time_constant_up>0.02</time_constant_up>
      <time_constant_down>0.04</time_constant_down>
      <rotor_drag_coefficient>1.0e-6</rotor_drag_coefficient>
      <rolling_moment_coefficient>1.0e-7</rolling_moment_coefficient>
    </plugin>

    <plugin filename="gz-sim-multicopter-motor-model-system"
            name="gz::sim::systems::MulticopterMotorModel">
      <joint_name>rotor_1_joint</joint_name>
      <link_name>base_link</link_name>
      <turning_direction>ccw</turning_direction>
      <motor_constant>3.6e-6</motor_constant>
      <moment_constant>1.0e-7</moment_constant>
      <max_rot_velocity>2200</max_rot_velocity>
      <time_constant_up>0.02</time_constant_up>
      <time_constant_down>0.04</time_constant_down>
      <rotor_drag_coefficient>1.0e-6</rotor_drag_coefficient>
      <rolling_moment_coefficient>1.0e-7</rolling_moment_coefficient>
    </plugin>

    <plugin filename="gz-sim-multicopter-motor-model-system"
            name="gz::sim::systems::MulticopterMotorModel">
      <joint_name>rotor_2_joint</joint_name>
      <link_name>base_link</link_name>
      <turning_direction>cw</turning_direction>
      <motor_constant>3.6e-6</motor_constant>
      <moment_constant>1.0e-7</moment_constant>
      <max_rot_velocity>2200</max_rot_velocity>
      <time_constant_up>0.02</time_constant_up>
      <time_constant_down>0.04</time_constant_down>
      <rotor_drag_coefficient>1.0e-6</rotor_drag_coefficient>
      <rolling_moment_coefficient>1.0e-7</rolling_moment_coefficient>
    </plugin>

    <plugin filename="gz-sim-multicopter-motor-model-system"
            name="gz::sim::systems::MulticopterMotorModel">
      <joint_name>rotor_3_joint</joint_name>
      <link_name>base_link</link_name>
      <turning_direction>cw</turning_direction>
      <motor_constant>3.6e-6</motor_constant>
      <moment_constant>1.0e-7</moment_constant>
      <max_rot_velocity>2200</max_rot_velocity>
      <time_constant_up>0.02</time_constant_up>
      <time_constant_down>0.04</time_constant_down>
      <rotor_drag_coefficient>1.0e-6</rotor_drag_coefficient>
      <rolling_moment_coefficient>1.0e-7</rolling_moment_coefficient>
    </plugin>

    <!-- Pusher motor: conservative start (tune later).
         You may also choose to use a different motor model if you prefer (fixed-wing prop model). -->
    <plugin filename="gz-sim-multicopter-motor-model-system"
            name="gz::sim::systems::MulticopterMotorModel">
      <joint_name>rotor_pusher_joint</joint_name>
      <link_name>base_link</link_name>
      <turning_direction>cw</turning_direction>
      <motor_constant>8.0e-6</motor_constant>
      <moment_constant>0.0</moment_constant>
      <max_rot_velocity>1600</max_rot_velocity>
      <time_constant_up>0.05</time_constant_up>
      <time_constant_down>0.08</time_constant_down>
      <rotor_drag_coefficient>1.0e-6</rotor_drag_coefficient>
      <rolling_moment_coefficient>0.0</rolling_moment_coefficient>
    </plugin>

    <!-- =========================== -->
    <!-- FIXED-WING AERODYNAMICS     -->
    <!-- =========================== -->
    <!-- Main wing/body LiftDrag (S5020-style approximation).
         Targets: best efficiency AoA ~2–4 deg, cruise 70–90 km/h. -->
    <plugin filename="gz-sim-lift-drag-system" name="gz::sim::systems::LiftDrag">
      <a0>0.03</a0>
      <cla>4.25</cla>
      <cda>0.04</cda>
      <cma>0.0</cma>

      <alpha_stall>0.28</alpha_stall>
      <cla_stall>0.0</cla_stall>
      <cda_stall>0.9</cda_stall>

      <area>0.31</area>
      <air_density>1.2041</air_density>

      <forward>1 0 0</forward>
      <upward>0 0 1</upward>
      <link_name>base_link</link_name>

      <!-- CP slightly aft to reduce pitch-up. Adjust in flight-tuning if needed. -->
      <cp>-0.06 0 0</cp>
    </plugin>

    <!-- Optional parasite-drag proxy to help match cruise throttle -->
    <plugin filename="gz-sim-lift-drag-system" name="gz::sim::systems::LiftDrag">
      <a0>0.0</a0>
      <cla>0.0</cla>
      <cda>0.08</cda>
      <alpha_stall>0.52</alpha_stall>
      <cla_stall>0.0</cla_stall>
      <cda_stall>0.2</cda_stall>
      <area>0.06</area>
      <air_density>1.2041</air_density>
      <forward>1 0 0</forward>
      <upward>0 0 1</upward>
      <link_name>base_link</link_name>
      <cp>0 0 0</cp>
    </plugin>

    <!-- =========================== -->
    <!-- ELEVONS + AERO COUPLING     -->
    <!-- =========================== -->
    <link name="left_elevon">
      <pose relative_to="base_link">-0.25000 0.36434 -0.0030 0 0 0</pose>
      <inertial>
        <mass>0.02</mass>
        <inertia>
          <ixx>1e-4</ixx><iyy>1e-4</iyy><izz>1e-4</izz>
        </inertia>
      </inertial>
      <visual name="left_elevon_visual">
        <pose>-0.0251825455 -0.1564833790 -0.0048282174 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/super_elevon_left.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material><ambient>0 0 0 1</ambient><diffuse>0 0 0 1</diffuse></material>
      </visual>
    </link>

    <joint name="left_elevon_joint" type="revolute">
      <parent>base_link</parent>
      <child>left_elevon</child>
      <axis>
        <xyz>0 1 0</xyz>
        <limit><lower>-0.45</lower><upper>0.45</upper></limit>
        <dynamics><damping>3.0</damping><spring_stiffness>60.0</spring_stiffness></dynamics>
      </axis>
    </joint>

    <link name="right_elevon">
      <pose relative_to="base_link">-0.25000 -0.36434 -0.0030 0 0 0</pose>
      <inertial>
        <mass>0.02</mass>
        <inertia>
          <ixx>1e-4</ixx><iyy>1e-4</iyy><izz>1e-4</izz>
        </inertia>
      </inertial>
      <visual name="right_elevon_visual">
        <pose>-0.0233319545 -0.1552907338 -0.0049171962 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/super_elevon_right.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material><ambient>0 0 0 1</ambient><diffuse>0 0 0 1</diffuse></material>
      </visual>
    </link>

    <joint name="right_elevon_joint" type="revolute">
      <parent>base_link</parent>
      <child>right_elevon</child>
      <axis>
        <xyz>0 1 0</xyz>
        <limit><lower>-0.45</lower><upper>0.45</upper></limit>
        <dynamics><damping>3.0</damping><spring_stiffness>60.0</spring_stiffness></dynamics>
      </axis>
    </joint>

    <!-- Elevon aero effect applied to base_link; coupled to joint angle. -->
    <plugin filename="gz-sim-lift-drag-system" name="gz::sim::systems::LiftDrag">
      <a0>0.0</a0>
      <cla>5.5</cla>
      <cda>0.03</cda>
      <alpha_stall>0.35</alpha_stall>
      <cla_stall>0.0</cla_stall>
      <cda_stall>0.6</cda_stall>
      <area>0.035</area>
      <air_density>1.2041</air_density>
      <forward>1 0 0</forward>
      <upward>0 0 1</upward>
      <link_name>base_link</link_name>
      <cp>-0.28 0.33 0</cp>
      <control_joint_name>left_elevon_joint</control_joint_name>
      <control_joint_rad_to_cl>2.8</control_joint_rad_to_cl>
    </plugin>

    <plugin filename="gz-sim-lift-drag-system" name="gz::sim::systems::LiftDrag">
      <a0>0.0</a0>
      <cla>5.5</cla>
      <cda>0.03</cda>
      <alpha_stall>0.35</alpha_stall>
      <cla_stall>0.0</cla_stall>
      <cda_stall>0.6</cda_stall>
      <area>0.035</area>
      <air_density>1.2041</air_density>
      <forward>1 0 0</forward>
      <upward>0 0 1</upward>
      <link_name>base_link</link_name>
      <cp>-0.28 -0.33 0</cp>
      <control_joint_name>right_elevon_joint</control_joint_name>
      <control_joint_rad_to_cl>2.8</control_joint_rad_to_cl>
    </plugin>

    <!-- =========================== -->
    <!-- IMU + MAG + AIRSPEED LINK   -->
    <!-- =========================== -->
    <link name="imu_link">
      <pose relative_to="base_link">0 0 0 0 0 0</pose>
      <inertial>
        <mass>0.0001</mass>
        <inertia>
          <ixx>1e-9</ixx><iyy>1e-9</iyy><izz>1e-9</izz>
        </inertia>
      </inertial>

      <sensor name="imu_sensor" type="imu">
        <!-- Keep your earlier pose; if attitude axes are inverted, change here or transforms. -->
        <pose>0 0 0 3.141593 0 0</pose>
        <always_on>true</always_on>
        <update_rate>1000</update_rate>
      </sensor>

      <sensor name="mag_sensor" type="magnetometer">
        <always_on>true</always_on>
        <update_rate>100</update_rate>
      </sensor>

      <sensor name="air_speed" type="air_pressure">
        <always_on>true</always_on>
        <update_rate>50</update_rate>
        <pose>0.35 0 0.05 0 0 0</pose>
        <visualize>true</visualize>
      </sensor>
    </link>

    <joint name="imu_joint" type="fixed">
      <parent>base_link</parent>
      <child>imu_link</child>
    </joint>

    <!-- =========================== -->
    <!-- UTILITY PUBLISHERS          -->
    <!-- =========================== -->
    <plugin filename="gz-sim-joint-state-publisher-system"
            name="gz::sim::systems::JointStatePublisher"/>
    <plugin filename="gz-sim-pose-publisher-system"
            name="gz::sim::systems::PosePublisher">
      <publish_model_pose>true</publish_model_pose>
      <publish_link_pose>true</publish_link_pose>
      <update_frequency>50</update_frequency>
    </plugin>

    <!-- =========================== -->
    <!-- ARDUPILOT INTERFACE PLUGIN  -->
    <!-- =========================== -->
    <!-- Your confirmed mapping:
         channels 4..7 are VTOL lift motors; channel 2 is pusher.
         channels 0..1 are elevons (POSITION). -->
    <plugin name="ArduPilotPlugin" filename="libArduPilotPlugin.so">
      <connectionTimeoutMaxCount>5</connectionTimeoutMaxCount>
      <lock_step>1</lock_step>

      <!-- Keep your transforms; if pitch/roll are wrong, we adjust these, not geometry. -->
      <modelXYZToAirplaneXForwardZDown degrees="true">
        0 0 0 180 0 0
      </modelXYZToAirplaneXForwardZDown>
      <gazeboXYZToNED degrees="true">
        0 0 0 180 0 90
      </gazeboXYZToNED>

      <sensors>
        <imu>imu_sensor</imu>
        <gps>gps_sensor</gps>
        <magnetometer>mag_sensor</magnetometer>
        <air_pressure>air_speed</air_pressure>
      </sensors>

      <!-- Elevons -->
      <control channel="0">
        <jointName>left_elevon_joint</jointName>
        <useForce>1</useForce>
        <multiplier>1.0</multiplier>
        <offset>0</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>POSITION</type>
        <p_gain>8.0</p_gain>
      </control>

      <control channel="1">
        <jointName>right_elevon_joint</jointName>
        <useForce>1</useForce>
        <multiplier>1.0</multiplier>
        <offset>0</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>POSITION</type>
        <p_gain>8.0</p_gain>
      </control>

      <!-- Pusher (VELOCITY rad/s) -->
      <control channel="2">
        <jointName>rotor_pusher_joint</jointName>
        <useForce>1</useForce>
        <multiplier>1.6</multiplier>
        <offset>0</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>VELOCITY</type>
        <p_gain>0.20</p_gain>
        <cmd_max>1600</cmd_max>
        <cmd_min>0</cmd_min>
      </control>

      <!-- VTOL lift motors -->
      <control channel="4">
        <jointName>rotor_0_joint</jointName>
        <useForce>1</useForce>
        <multiplier>2.2</multiplier>
        <offset>0</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>VELOCITY</type>
        <p_gain>0.15</p_gain>
        <cmd_max>2200</cmd_max>
        <cmd_min>0</cmd_min>
      </control>

      <control channel="5">
        <jointName>rotor_1_joint</jointName>
        <useForce>1</useForce>
        <multiplier>2.2</multiplier>
        <offset>0</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>VELOCITY</type>
        <p_gain>0.15</p_gain>
        <cmd_max>2200</cmd_max>
        <cmd_min>0</cmd_min>
      </control>

      <control channel="6">
        <jointName>rotor_2_joint</jointName>
        <useForce>1</useForce>
        <multiplier>2.2</multiplier>
        <offset>0</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>VELOCITY</type>
        <p_gain>0.15</p_gain>
        <cmd_max>2200</cmd_max>
        <cmd_min>0</cmd_min>
      </control>

      <control channel="7">
        <jointName>rotor_3_joint</jointName>
        <useForce>1</useForce>
        <multiplier>2.2</multiplier>
        <offset>0</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>VELOCITY</type>
        <p_gain>0.15</p_gain>
        <cmd_max>2200</cmd_max>
        <cmd_min>0</cmd_min>
      </control>
    </plugin>

  </model>
</sdf>

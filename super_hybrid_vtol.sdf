<?xml version="1.0"?>
<!--
===============================================================================
SUPER STINGRAY QUADPLANE VTOL — ARDUPILOT SITL + GAZEBO HARMONIC (gz sim)
===============================================================================

Purpose
-------
This SDF describes a physically plausible quadplane VTOL flying-wing aircraft
for use with ArduPilot (ArduPlane with QuadPlane enabled) and the official
ArduPilot Gazebo Harmonic plugin (libArduPilotPlugin.so).  It preserves the
masses and the geometric placement of all VTOL and pusher rotors exactly as
you provided.  The key corrections are limited to the *propulsion/thrust*
modeling and control interfaces so that vertical lift is produced correctly
and the rapid forward flip at liftoff is eliminated.

Key Design Decisions (ArduPilot-correct)
----------------------------------------
1) Rotors are driven as **VELOCITY** joints by **ArduPilotPlugin** (only).
   There is NO JointVelocityController topic wiring here; that pattern is
   used in some PX4 examples but not with ArduPilot’s plugin.

2) Thrust for each rotor is produced by the **MulticopterMotorModel** system,
   which converts commanded angular velocity (rad/s) into thrust/torque using
   ω² relationships.  This is appropriate for hover rotors and matches what
   ArduPilot’s mixer expects.

3) The **PWM → rad/s mapping** inside ArduPilotPlugin is linear and *clamped*:
        cmd = clamp( (PWM + offset) * multiplier, cmd_min, cmd_max )
   With:
        offset     = -1000
        multiplier = cmd_max / 1000
   Thus:
        PWM=1000 → 0 rad/s
        PWM=2000 → cmd_max rad/s
   Lift rotors use cmd_max=2200 → multiplier=2.2
   Pusher uses cmd_max=1600 → multiplier=1.6

4) To ensure positive upward reaction, all **lift rotor joint axes are 0 0 -1**.
   This is a common requirement with Gazebo Harmonic motor models due to the
   internal direction conventions between joint axis and force application.
   Geometry, masses, and positions are unchanged; only the axis sign is set.

5) Wing and elevon aerodynamics remain modeled by **LiftDrag** plugins for
   realism in forward flight.  These act on the main body and couple to the
   elevon joints.  No LiftDrag is used for the lift rotors (rotors use
   MulticopterMotorModel exclusively).

What Was Fixed (why the craft used to tip/flip or not lift)
-----------------------------------------------------------
- Lift rotor thrust was previously modeled with LiftDrag “blades”. That model
  needs translational airflow and doesn’t directly convert commanded RPM to
  hover thrust. Result: motors “spin” visually but generate insufficient or
  misdirected thrust at liftoff, often producing a nose-down moment.

- Switched each VTOL rotor to MulticopterMotorModel, ensured proper joint axis
  signs (0 0 -1), and used linear PWM→ω mapping in ArduPilotPlugin exactly as
  ArduPilot expects.  This yields consistent upward thrust and stable VTOL
  takeoff without changing your masses or rotor/pusher positions.

Mass/Placement Promise (kept)
-----------------------------
- base_link mass:          2.45
- rotor_0..3 mass:         0.04 each
- rotor_pusher mass:       0.09
- elevons mass:            0.05 each
- IMU link mass:           0.0001
- Rotor and pusher link Poses relative to base_link: **unchanged**
- Visual meshes, scales, and placements: **unchanged**

ArduPilot Notes
---------------
- Run ArduPlane SITL with QuadPlane frame as you already do.
- Typical test: QLOITER → arm throttle → "takeoff 10" or GUIDED VTOL takeoff.
- Unequal servo outputs are expected as the controller mixes for attitude.

===============================================================================
-->
<sdf version="1.9">
  <model name="super_hybrid_vtol">
    <!-- Spawn slightly above ground -->
    <pose>0 0 0.3 0 0 0</pose>

    <!-- =========================================================================
         BASE LINK  (AIRFRAME / MAIN BODY)
         ========================================================================= -->
    <link name="base_link">
      <!-- Reference pose of base in model frame -->
      <pose>0 0 0 0 0 0</pose>

      <!-- Inertial properties (kept as supplied) -->
      <inertial>
        <!-- CG at origin in your last provided model; mass unchanged -->
        <pose>0 0 0 0 0 0</pose>
        <mass>2.45</mass>
        <inertia>
          <ixx>0.20</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>0.15</iyy>
          <iyz>0</iyz>
          <izz>0.25</izz>
        </inertia>
      </inertial>

      <!-- Simple collision hull (box) to contact the ground -->
      <collision name="base_link_collision">
        <pose>0 0 -0.05 0 0 0</pose>
        <geometry>
          <box>
            <!-- length (X)  span (Y)  thickness (Z) -->
            <size>0.70 1.13 0.108</size>
          </box>
        </geometry>
        <surface>
          <friction>
            <ode>
              <mu>1.0</mu>
              <mu2>1.0</mu2>
            </ode>
          </friction>
          <contact>
            <ode>
              <kp>500000.0</kp>
              <kd>50.0</kd>
              <min_depth>0.001</min_depth>
            </ode>
          </contact>
        </surface>
      </collision>

      <!-- Visual mesh of the Super Stingray fuselage/wing -->
      <visual name="base_link_visual">
        <pose>0 0 -0.38621 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/super_fus.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material>
          <ambient>0.60 0.60 0.60 1</ambient>
          <diffuse>0.60 0.60 0.60 1</diffuse>
        </material>
      </visual>

      <!-- GPS sensor (wired to ArduPilot via ArduPilotPlugin) -->
      <sensor name="gps_sensor" type="gps">
        <always_on>true</always_on>
        <update_rate>10</update_rate>
        <!-- The plugin tag under a sensor is ignored by Harmonic for ArduPilot;
             actual sensor hookup is specified inside the ArduPilotPlugin block. -->
      </sensor>
    </link>

    <!-- =========================================================================
         VTOL ROTORS (4x Lift) — links and joints only here; thrust via motor model
         =========================================================================
         IMPORTANT:
         - Masses and positions are kept exactly as you provided.
         - Joint axes for LIFT rotors are 0 0 -1 to ensure upward reaction.
         - No LiftDrag on these links; MulticopterMotorModel provides thrust/torque.
         ========================================================================= -->

    <!-- rotor_0 : FRONT-RIGHT (CCW mesh) -->
    <link name="rotor_0">
      <pose relative_to="base_link">0.19257 -0.21068 -0.0045 0 0 0</pose>
      <inertial>
        <mass>0.04</mass>
        <inertia>
          <ixx>5e-5</ixx>
          <iyy>5e-5</iyy>
          <izz>5e-5</izz>
        </inertia>
      </inertial>
      <visual name="rotor_0_visual">
        <pose>-0.0070034310 -0.0647861960 -0.0065644327 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/vtol_prop_ccw.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material>
          <ambient>0 0 0 1</ambient>
          <diffuse>0 0 0 1</diffuse>
        </material>
      </visual>
    </link>
    <joint name="rotor_0_joint" type="revolute">
      <parent>base_link</parent>
      <child>rotor_0</child>
      <axis>
        <!-- Upward reaction requires axis 0 0 -1 with this motor model -->
        <xyz>0 0 -1</xyz>
        <limit>
          <lower>-1e16</lower>
          <upper>1e16</upper>
        </limit>
        <dynamics>
          <damping>0.003</damping>
        </dynamics>
      </axis>
    </joint>

    <!-- rotor_1 : REAR-LEFT (CCW mesh) -->
    <link name="rotor_1">
      <pose relative_to="base_link">-0.33549 0.21128 -0.0045 0 0 0</pose>
      <inertial>
        <mass>0.04</mass>
        <inertia>
          <ixx>5e-5</ixx>
          <iyy>5e-5</iyy>
          <izz>5e-5</izz>
        </inertia>
      </inertial>
      <visual name="rotor_1_visual">
        <pose>-0.0070034310 -0.0647861960 -0.0065644327 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/vtol_prop_ccw.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material>
          <ambient>0 0 0 1</ambient>
          <diffuse>0 0 0 1</diffuse>
        </material>
      </visual>
    </link>
    <joint name="rotor_1_joint" type="revolute">
      <parent>base_link</parent>
      <child>rotor_1</child>
      <axis>
        <xyz>0 0 -1</xyz>
        <limit>
          <lower>-1e16</lower>
          <upper>1e16</upper>
        </limit>
        <dynamics>
          <damping>0.003</damping>
        </dynamics>
      </axis>
    </joint>

    <!-- rotor_2 : FRONT-LEFT (CW mesh) -->
    <link name="rotor_2">
      <pose relative_to="base_link">0.19571 0.21128 -0.0045 0 0 0</pose>
      <inertial>
        <mass>0.04</mass>
        <inertia>
          <ixx>5e-5</ixx>
          <iyy>5e-5</iyy>
          <izz>5e-5</izz>
        </inertia>
      </inertial>
      <visual name="rotor_2_visual">
        <pose>-0.0070594754 -0.0647858828 -0.0066520433 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/vtol_prop_cw.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material>
          <ambient>0 0 0 1</ambient>
          <diffuse>0 0 0 1</diffuse>
        </material>
      </visual>
    </link>
    <joint name="rotor_2_joint" type="revolute">
      <parent>base_link</parent>
      <child>rotor_2</child>
      <axis>
        <xyz>0 0 -1</xyz>
        <limit>
          <lower>-1e16</lower>
          <upper>1e16</upper>
        </limit>
        <dynamics>
          <damping>0.003</damping>
        </dynamics>
      </axis>
    </joint>

    <!-- rotor_3 : REAR-RIGHT (CW mesh) -->
    <link name="rotor_3">
      <pose relative_to="base_link">-0.33863 -0.21068 -0.0045 0 0 0</pose>
      <inertial>
        <mass>0.04</mass>
        <inertia>
          <ixx>5e-5</ixx>
          <iyy>5e-5</iyy>
          <izz>5e-5</izz>
        </inertia>
      </inertial>
      <visual name="rotor_3_visual">
        <pose>-0.0070594754 -0.0647858828 -0.0066520433 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/vtol_prop_cw.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material>
          <ambient>0 0 0 1</ambient>
          <diffuse>0 0 0 1</diffuse>
        </material>
      </visual>
    </link>
    <joint name="rotor_3_joint" type="revolute">
      <parent>base_link</parent>
      <child>rotor_3</child>
      <axis>
        <xyz>0 0 -1</xyz>
        <limit>
          <lower>-1e16</lower>
          <upper>1e16</upper>
        </limit>
        <dynamics>
          <damping>0.003</damping>
        </dynamics>
      </axis>
    </joint>

    <!-- =========================================================================
         REAR PUSHER ROTOR (forward-flight prop) — position & mass unchanged
         ========================================================================= -->
    <link name="rotor_pusher">
      <pose relative_to="base_link">-0.2953 0 -0.0065 0 0 0</pose>
      <inertial>
        <mass>0.09</mass>
        <inertia>
          <ixx>8e-5</ixx>
          <iyy>8e-5</iyy>
          <izz>8e-5</izz>
        </inertia>
      </inertial>
      <visual name="rotor_pusher_visual">
        <pose>-0.0075749999 -0.0125011178 -0.1267471462 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/super_pusher_prop.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material>
          <ambient>0 0 0 1</ambient>
          <diffuse>0 0 0 1</diffuse>
        </material>
      </visual>
    </link>
    <joint name="rotor_pusher_joint" type="revolute">
      <parent>base_link</parent>
      <child>rotor_pusher</child>
      <axis>
        <!-- Pusher spins about +X -->
        <xyz>1 0 0</xyz>
        <limit>
          <lower>-1e16</lower>
          <upper>1e16</upper>
        </limit>
        <dynamics>
          <damping>0.003</damping>
        </dynamics>
      </axis>
    </joint>

    <!-- =========================================================================
         MULTICOPTER MOTOR MODELS  (thrust & yaw torque from commanded ω)
         =========================================================================
         - All lift motors use the same constants, tuned for ~2.8 kg AUW.
         - motor_constant is sized so that at ω≈2200 rad/s each rotor supplies
           realistic thrust; adjust slightly if later tuning requires it.
         - moment_constant is small but non-zero to allow yaw control in hover.
         - time constants give a crisp but stable response.
         ========================================================================= -->

    <!-- Lift rotor 0 -->
    <plugin filename="gz-sim-multicopter-motor-model-system"
            name="gz::sim::systems::MulticopterMotorModel">
      <joint_name>rotor_0_joint</joint_name>
      <link_name>rotor_0</link_name>
      <turning_direction>ccw</turning_direction>
      <motor_constant>3.6e-6</motor_constant>
      <moment_constant>1.0e-7</moment_constant>
      <max_rot_velocity>2200</max_rot_velocity>
      <time_constant_up>0.03</time_constant_up>
      <time_constant_down>0.05</time_constant_down>
      <rotor_drag_coefficient>1.0e-6</rotor_drag_coefficient>
      <rolling_moment_coefficient>0.0</rolling_moment_coefficient>
    </plugin>

    <!-- Lift rotor 1 -->
    <plugin filename="gz-sim-multicopter-motor-model-system"
            name="gz::sim::systems::MulticopterMotorModel">
      <joint_name>rotor_1_joint</joint_name>
      <link_name>rotor_1</link_name>
      <turning_direction>ccw</turning_direction>
      <motor_constant>3.6e-6</motor_constant>
      <moment_constant>1.0e-7</moment_constant>
      <max_rot_velocity>2200</max_rot_velocity>
      <time_constant_up>0.03</time_constant_up>
      <time_constant_down>0.05</time_constant_down>
      <rotor_drag_coefficient>1.0e-6</rotor_drag_coefficient>
      <rolling_moment_coefficient>0.0</rolling_moment_coefficient>
    </plugin>

    <!-- Lift rotor 2 -->
    <plugin filename="gz-sim-multicopter-motor-model-system"
            name="gz::sim::systems::MulticopterMotorModel">
      <joint_name>rotor_2_joint</joint_name>
      <link_name>rotor_2</link_name>
      <turning_direction>cw</turning_direction>
      <motor_constant>3.6e-6</motor_constant>
      <moment_constant>1.0e-7</moment_constant>
      <max_rot_velocity>2200</max_rot_velocity>
      <time_constant_up>0.03</time_constant_up>
      <time_constant_down>0.05</time_constant_down>
      <rotor_drag_coefficient>1.0e-6</rotor_drag_coefficient>
      <rolling_moment_coefficient>0.0</rolling_moment_coefficient>
    </plugin>

    <!-- Lift rotor 3 -->
    <plugin filename="gz-sim-multicopter-motor-model-system"
            name="gz::sim::systems::MulticopterMotorModel">
      <joint_name>rotor_3_joint</joint_name>
      <link_name>rotor_3</link_name>
      <turning_direction>cw</turning_direction>
      <motor_constant>3.6e-6</motor_constant>
      <moment_constant>1.0e-7</moment_constant>
      <max_rot_velocity>2200</max_rot_velocity>
      <time_constant_up>0.03</time_constant_up>
      <time_constant_down>0.05</time_constant_down>
      <rotor_drag_coefficient>1.0e-6</rotor_drag_coefficient>
      <rolling_moment_coefficient>0.0</rolling_moment_coefficient>
    </plugin>

    <!-- Pusher rotor (forward thrust along +X) -->
    <plugin filename="gz-sim-multicopter-motor-model-system"
            name="gz::sim::systems::MulticopterMotorModel">
      <joint_name>rotor_pusher_joint</joint_name>
      <link_name>rotor_pusher</link_name>
      <turning_direction>cw</turning_direction>
      <motor_constant>8.0e-6</motor_constant>
      <moment_constant>0.0</moment_constant>
      <max_rot_velocity>1600</max_rot_velocity>
      <time_constant_up>0.06</time_constant_up>
      <time_constant_down>0.10</time_constant_down>
      <rotor_drag_coefficient>1.0e-6</rotor_drag_coefficient>
      <rolling_moment_coefficient>0.0</rolling_moment_coefficient>
    </plugin>

    <!-- =========================================================================
         MAIN WING / BODY AERODYNAMICS (acts on base_link)
         ========================================================================= -->
    <plugin filename="gz-sim-lift-drag-system" name="gz::sim::systems::LiftDrag">
      <!-- S5020-like flying-wing characteristics; values per your last working set -->
      <a0>0.05</a0>
      <cla>4.25</cla>
      <cda>0.08</cda>
      <alpha_stall>0.35</alpha_stall>
      <cla_stall>0.0</cla_stall>
      <cda_stall>0.9</cda_stall>
      <area>0.31</area>
      <air_density>1.2041</air_density>
      <forward>1 0 0</forward>
      <upward>0 0 1</upward>
      <link_name>base_link</link_name>
      <cp>-0.06 0 0</cp>
    </plugin>

    <!-- Optional body drag-only contribution (kept conservative) -->
    <plugin filename="gz-sim-lift-drag-system" name="gz::sim::systems::LiftDrag">
      <a0>0.0</a0>
      <cla>0.0</cla>
      <cda>0.08</cda>
      <alpha_stall>0.52</alpha_stall>
      <cla_stall>0.0</cla_stall>
      <cda_stall>0.2</cda_stall>
      <area>0.06</area>
      <air_density>1.2041</air_density>
      <forward>1 0 0</forward>
      <upward>0 0 1</upward>
      <link_name>base_link</link_name>
      <cp>0 0 0</cp>
    </plugin>

    <!-- =========================================================================
         ELEVONS (links, joints, and aero coupling)
         ========================================================================= -->
    <link name="left_elevon">
      <pose relative_to="base_link">-0.25000 0.36434 -0.0030 0.01 0 0.400</pose>
      <inertial>
        <mass>0.05</mass>
        <inertia>
          <ixx>0.001</ixx>
          <iyy>0.001</iyy>
          <izz>0.001</izz>
        </inertia>
      </inertial>
      <visual name="left_elevon_visual">
        <pose>-0.0251825455 -0.1564833790 -0.0048282174 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/super_elevon_left.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material>
          <ambient>0 0 0 1</ambient>
          <diffuse>0 0 0 1</diffuse>
        </material>
      </visual>
    </link>
    <joint name="left_elevon_joint" type="revolute">
      <parent>base_link</parent>
      <child>left_elevon</child>
      <axis>
        <xyz>0 1 0</xyz>
        <limit>
          <lower>-0.53</lower>
          <upper>0.53</upper>
        </limit>
        <dynamics>
          <damping>5.0</damping>
          <spring_stiffness>100.0</spring_stiffness>
        </dynamics>
      </axis>
    </joint>

    <link name="right_elevon">
      <pose relative_to="base_link">-0.25000 -0.36434 -0.0030 -0.01 0 -0.400</pose>
      <inertial>
        <mass>0.05</mass>
        <inertia>
          <ixx>0.001</ixx>
          <iyy>0.001</iyy>
          <izz>0.001</izz>
        </inertia>
      </inertial>
      <visual name="right_elevon_visual">
        <pose>-0.0233319545 -0.1552907338 -0.0049171962 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://super_hybrid_vtol/meshes/super_elevon_right.STL</uri>
            <scale>1 1 1</scale>
          </mesh>
        </geometry>
        <material>
          <ambient>0 0 0 1</ambient>
          <diffuse>0 0 0 1</diffuse>
        </material>
      </visual>
    </link>
    <joint name="right_elevon_joint" type="revolute">
      <parent>base_link</parent>
      <child>right_elevon</child>
      <axis>
        <xyz>0 1 0</xyz>
        <limit>
          <lower>-0.53</lower>
          <upper>0.53</upper>
        </limit>
        <dynamics>
          <damping>5.0</damping>
          <spring_stiffness>100.0</spring_stiffness>
        </dynamics>
      </axis>
    </joint>

    <!-- Elevon aerodynamic coupling onto the main body -->
    <plugin filename="gz-sim-lift-drag-system" name="gz::sim::systems::LiftDrag">
      <a0>0.15</a0>
      <cla>6.8</cla>
      <cda>0.06</cda>
      <alpha_stall>0.35</alpha_stall>
      <cla_stall>0.0</cla_stall>
      <cda_stall>0.6</cda_stall>
      <area>0.04</area>
      <air_density>1.2041</air_density>
      <forward>1 0 0</forward>
      <upward>0 0 1</upward>
      <link_name>base_link</link_name>
      <cp>-0.28 0.33 0</cp>
      <control_joint_name>left_elevon_joint</control_joint_name>
      <!-- Negative coupling: positive deflection reduces local lift for roll -->
      <control_joint_rad_to_cl>-4.0</control_joint_rad_to_cl>
    </plugin>

    <plugin filename="gz-sim-lift-drag-system" name="gz::sim::systems::LiftDrag">
      <a0>0.15</a0>
      <cla>6.8</cla>
      <cda>0.06</cda>
      <alpha_stall>0.35</alpha_stall>
      <cla_stall>0.0</cla_stall>
      <cda_stall>0.6</cda_stall>
      <area>0.04</area>
      <air_density>1.2041</air_density>
      <forward>1 0 0</forward>
      <upward>0 0 1</upward>
      <link_name>base_link</link_name>
      <cp>-0.28 -0.33 0</cp>
      <control_joint_name>right_elevon_joint</control_joint_name>
      <control_joint_rad_to_cl>-4.0</control_joint_rad_to_cl>
    </plugin>

    <!-- =========================================================================
         IMU / MAG / AIRSPEED SENSORS (fed to ArduPilot via ArduPilotPlugin)
         ========================================================================= -->
    <link name="imu_link">
      <pose relative_to="base_link">0 0 0 0 0 0</pose>
      <inertial>
        <mass>0.0001</mass>
        <inertia>
          <ixx>1e-9</ixx>
          <iyy>1e-9</iyy>
          <izz>1e-9</izz>
        </inertia>
      </inertial>

      <sensor name="imu_sensor" type="imu">
        <!-- IMU orientation aligned with model frame (X fwd, Y right, Z up) -->
        <pose>0 0 0 0 0 0</pose>
        <always_on>true</always_on>
        <update_rate>1000</update_rate>
      </sensor>

      <sensor name="mag_sensor" type="magnetometer">
        <always_on>true</always_on>
        <update_rate>100</update_rate>
      </sensor>

      <sensor name="air_speed" type="air_pressure">
        <always_on>true</always_on>
        <update_rate>100</update_rate>
        <pose>0.35 0 0.05 0 0 0</pose>
        <visualize>true</visualize>
        <air_pressure>
          <pressure>
            <noise type="gaussian">
              <mean>0</mean>
              <stddev>0.01</stddev>
            </noise>
          </pressure>
        </air_pressure>
      </sensor>
    </link>

    <joint name="imu_joint" type="fixed">
      <parent>base_link</parent>
      <child>imu_link</child>
    </joint>

    <!-- =========================================================================
         UTILITY PUBLISHERS (optional; helpful for debugging/visualization)
         ========================================================================= -->
    <plugin filename="gz-sim-joint-state-publisher-system"
            name="gz::sim::systems::JointStatePublisher"/>

    <plugin filename="gz-sim-pose-publisher-system"
            name="gz::sim::systems::PosePublisher">
      <publish_model_pose>true</publish_model_pose>
      <publish_link_pose>true</publish_link_pose>
      <update_frequency>50</update_frequency>
    </plugin>

    <!-- =========================================================================
         ARDUPILOT INTERFACE PLUGIN (the only controller of joints)
         =========================================================================
         - Channels:
             0 : left elevon  (POSITION)
             1 : right elevon (POSITION)
             2 : pusher rotor (VELOCITY)
             4 : lift rotor 0 (VELOCITY)
             5 : lift rotor 1 (VELOCITY)
             6 : lift rotor 2 (VELOCITY)
             7 : lift rotor 3 (VELOCITY)
         - Linear PWM→ω mapping with offset=-1000 and multiplier=cmd_max/1000
         ========================================================================= -->
    <plugin name="ArduPilotPlugin" filename="libArduPilotPlugin.so">
      <!-- Robust startup with lockstep -->
      <connectionTimeoutMaxCount>5</connectionTimeoutMaxCount>
      <lock_step>1</lock_step>

      <!-- Coordinate frame conversions (your known-good values) -->
      <modelXYZToAirplaneXForwardZDown degrees="true">
        0 0 0 180 0 0
      </modelXYZToAirplaneXForwardZDown>
      <gazeboXYZToNED degrees="true">
        0 0 0 180 0 90
      </gazeboXYZToNED>

      <!-- Sensor wiring -->
      <sensors>
        <imu>imu_sensor</imu>
        <gps>gps_sensor</gps>
        <magnetometer>mag_sensor</magnetometer>
        <air_pressure>air_speed</air_pressure>
      </sensors>

      <!-- ================= Elevons ================= -->
      <control channel="0">
        <jointName>left_elevon_joint</jointName>
        <useForce>1</useForce>
        <multiplier>1.0</multiplier>
        <!-- Optional trim about neutral (kept small/zero here) -->
        <offset>0.0</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>POSITION</type>
        <p_gain>10.0</p_gain>
      </control>

      <control channel="1">
        <jointName>right_elevon_joint</jointName>
        <useForce>1</useForce>
        <multiplier>1.0</multiplier>
        <offset>0.0</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>POSITION</type>
        <p_gain>10.0</p_gain>
      </control>

      <!-- ================= Pusher (forward flight) ================= -->
      <control channel="2">
        <jointName>rotor_pusher_joint</jointName>
        <useForce>1</useForce>
        <!-- Linear map: PWM->ω  (offset=-1000, multiplier=1.6 for 0..1600) -->
        <offset>-1000</offset>
        <multiplier>1.6</multiplier>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>VELOCITY</type>
        <p_gain>0.25</p_gain>
        <cmd_max>1600</cmd_max>
        <cmd_min>0</cmd_min>
      </control>

      <!-- ================= Lift rotors (VTOL) ================= -->
      <control channel="4">
        <jointName>rotor_0_joint</jointName>
        <useForce>1</useForce>
        <offset>-1000</offset>
        <multiplier>2.2</multiplier>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>VELOCITY</type>
        <p_gain>0.25</p_gain>
        <cmd_max>2200</cmd_max>
        <cmd_min>0</cmd_min>
      </control>

      <control channel="5">
        <jointName>rotor_1_joint</jointName>
        <useForce>1</useForce>
        <offset>-1000</offset>
        <multiplier>2.2</multiplier>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>VELOCITY</type>
        <p_gain>0.25</p_gain>
        <cmd_max>2200</cmd_max>
        <cmd_min>0</cmd_min>
      </control>

      <control channel="6">
        <jointName>rotor_2_joint</jointName>
        <useForce>1</useForce>
        <offset>-1000</offset>
        <multiplier>2.2</multiplier>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>VELOCITY</type>
        <p_gain>0.25</p_gain>
        <cmd_max>2200</cmd_max>
        <cmd_min>0</cmd_min>
      </control>

      <control channel="7">
        <jointName>rotor_3_joint</jointName>
        <useForce>1</useForce>
        <offset>-1000</offset>
        <multiplier>2.2</multiplier>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>VELOCITY</type>
        <p_gain>0.25</p_gain>
        <cmd_max>2200</cmd_max>
        <cmd_min>0</cmd_min>
      </control>
    </plugin>

  </model>
</sdf>
